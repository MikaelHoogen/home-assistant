# packages/emhass/EMHASS_inndata.yaml
#
# Samlar all indata till MPC i en enda sensor.
# - Prognoser (priser/PV) tas direkt från sina respektive sensorer, utan skivning.
# - Alla MPC-parametrar och deferrables ingår.
# - Klar att POST:a direkt som JSON i MPC-anropet.

template:
  - sensor:
      - name: emhass_mpc_inputs
        unique_id: emhass_mpc_inputs
        state: "ok"

        attributes:
          ####################################################################
          # Index-info (mest för diagnos)
          ####################################################################
          step_minutes: 15
          i0: >
            {{ ((now().hour*60 + now().minute) // 15) }}

          ####################################################################
          # Prognoser (hela listorna från sensorerna)
          ####################################################################
          prod_price_forecast: "{{ state_attr('sensor.emhass_prices', 'sälj') | list }}"
          load_cost_forecast:  "{{ state_attr('sensor.emhass_prices', 'köp')  | list }}"
          pv_power_forecast:   "{{ state_attr('sensor.emhass_pv_forecast', 'pv_w_15min') | list }}"

          ####################################################################
          # MPC-parametrar (direkt från helpers / hårdkod)
          ####################################################################
          alpha: >
            {{ (1.0 - states('input_number.emhass_beta') | float(0)) | round(1) }}
          beta: "{{ states('input_number.emhass_beta') | float(0) }}"
          num_def_loads: 3
          num_lags: 192
          soc_init: >
            {{ min(1.0, (max(0.15, states('sensor.solar_battery_soc') | float(0) / 100))) }}
          treat_def_as_semi_cont: >
            {{ [true, true, true] | tojson }}

          # Nominell effekt för deferrable loads (W)
          P_deferrable_nom: >
            [
              {{ states('input_number.emhass_p_deferrable0_nom') | float(2000) }},
              900,
              2000
            ]

          # set_def_constant – din logik för def_0, nu i 15-min (*4)
          set_def_constant: >
            [
              {{
                'true' if (states('sensor.emhass_def_0_end_timestep')|int(0)
                          <= ((states('sensor.emhass_def_total_hours_vp')|float(0))*4)|int(0))
                else states('input_select.emhass_def_0_set_def_constant')
              }},
              false,
              false
            ]

          ####################################################################
          # Deferrables: timmar + start/slut i 15-min steg
          ####################################################################
          def_total_hours: >
            [
              {{ states('sensor.emhass_def_total_hours_vp')    | float(0) }},
              {{ states('sensor.emhass_def_total_hours_sbv')   | float(0) }},
              {{ states('sensor.emhass_def_total_hours_vp_24') | float(0) }}
            ]

          def_start_timestep: >
            [
              {{ states('sensor.emhass_def_0_start_timestep')|int(0) }},
              0,
              {{ states('sensor.emhass_def_2_start_timestep')|int(0) }}
            ]

          def_end_timestep: >
            [
              {{
                [ ((states('sensor.emhass_def_total_hours_vp')|float(0))*4)|int(0),
                  (states('sensor.emhass_def_0_end_timestep')|int(0))
                ]|max
              }},
              {{ states('sensor.emhass_def_1_end_timestep')|int(0) }},
              {{ states('sensor.emhass_def_2_end_timestep')|int(0) }}
            ]