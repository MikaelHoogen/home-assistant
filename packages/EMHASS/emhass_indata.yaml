# packages/emhass/EMHASS_inndata.yaml
#
# Syfte:
#  - Samla och förbereda all indata som MPC-anropet behöver.
#  - Hämta/prune/slice från våra pris- och PV-sensorer i 15-min upplösning.
#  - Spegla exakt de fält du använder i din shell payload, men UTAN att köra shell här.

template:
  - sensor:
      - name: emhass_mpc_inputs
        unique_id: emhass_mpc_inputs
        state: "ok"
        availability: >
          {{
            (state_attr('sensor.emhass_prices','sälj') is not none)
            and (state_attr('sensor.emhass_prices','köp')  is not none)
            and (state_attr('sensor.emhass_pv_forecast','pv_w_15min') is not none)
            and (state_attr('sensor.emhass_prices','sälj')|list|length > 0)
            and (state_attr('sensor.emhass_prices','köp') |list|length > 0)
            and (state_attr('sensor.emhass_pv_forecast','pv_w_15min')|list|length > 0)
          }}
        attributes:
          # --------------------------------------------------------
          # Indexering och horisont (15-min)
          # --------------------------------------------------------
          step_minutes: "{{ states('sensor.emhass_step_minutes_const')|int(15) }}"
          i0: >
            {% set m = states('sensor.emhass_step_minutes_const')|int(15) %}
            {{ ((now().hour*60 + now().minute) // m) }}
          horizon_steps: "{{ states('sensor.emhass_horizon_steps')|int(192) }}"

          # --------------------------------------------------------
          # 1) Priser i 15-min fönster från NU (samma som emhass_prices fast already-sliced)
          # --------------------------------------------------------
          load_cost_forecast: >
            {% set i0 = ((now().hour*60 + now().minute) // (states('sensor.emhass_step_minutes_const')|int(15))) %}
            {% set H  = states('sensor.emhass_horizon_steps')|int(192) %}
            {{ (state_attr('sensor.emhass_prices','köp') | list)[i0:][:H] }}

          prod_price_forecast: >
            {% set i0 = ((now().hour*60 + now().minute) // (states('sensor.emhass_step_minutes_const')|int(15))) %}
            {% set H  = states('sensor.emhass_horizon_steps')|int(192) %}
            {{ (state_attr('sensor.emhass_prices','sälj') | list)[i0:][:H] }}

          # --------------------------------------------------------
          # 2) PV-prognos i W, 15-min fönster från NU
          #    - Vi håller oss till W (som i din nuvarande pv_w_15min)
          # --------------------------------------------------------
          pv_power_forecast: >
            {% set i0 = ((now().hour*60 + now().minute) // (states('sensor.emhass_step_minutes_const')|int(15))) %}
            {% set H  = states('sensor.emhass_horizon_steps')|int(192) %}
            {{ (state_attr('sensor.emhass_pv_forecast','pv_w_15min') | list)[i0:][:H] }}

          # --------------------------------------------------------
          # 3) Övriga MPC-parametrar – speglar din shell payload
          # --------------------------------------------------------
          prediction_horizon: >
            {{ states('sensor.emhass_horizon_steps')|int(192) }}

          alpha: >
            {{ (1.0 - (states('input_number.emhass_beta')|float(0))) | round(1) }}

          beta: >
            {{ states('input_number.emhass_beta')|float(0) }}

          num_def_loads: 3

          # Sätt num_lags = horisontsteg (din tidigare 96 blir 192 på 15-min/48h)
          num_lags: >
            {{ states('sensor.emhass_horizon_steps')|int(192) }}

          # Nominell effekt för deferrable loads
          P_deferrable_nom: >
            [
              {{ states('input_number.emhass_p_deferrable0_nom') | float(2000) }},
              900,
              2000
            ]

          treat_def_as_semi_cont: "[true, true, true]"

          # Total tillåten tid (steg) för varje deferrable (dina existerande sensorer)
          def_total_hours: >
            [
              {{ states('sensor.emhass_def_total_hours_vp')|int(0) }},
              {{ states('sensor.emhass_def_total_hours_sbv')|int(0) }},
              {{ states('sensor.emhass_def_total_hours_vp_24')|int(0) }}
            ]

          # SOC init (0..1) – samma formel som i din shell
          soc_init: >
            {{ [1.0, [0.15, (states('sensor.solar_battery_soc')|float(0) / 100)]|max]|min }}

          # set_def_constant – exakt som din shell-logik för def_0
          set_def_constant: >
            [
              {{
                'true' if (states('sensor.emhass_def_0_end_timestep')|int(0)
                          <= ((states('sensor.emhass_def_total_hours_vp')|float(0))*4)|int(0))
                else states('input_select.emhass_def_0_set_def_constant')
              }},
              false,
              false
            ]

          # Start/Slut-steg (respekterar dina befintliga sensorer)
          def_start_timestep: >
            [
              {{ states('sensor.emhass_def_0_start_timestep')|int(0) }},
              0,
              {{ states('sensor.emhass_def_2_start_timestep')|int(0) }}
            ]

          def_end_timestep: >
            [
              {{
                [ ((states('sensor.emhass_def_total_hours_vp')|float(0))*4)|int(0),
                  (states('sensor.emhass_def_0_end_timestep')|int(0))
                ]|max
              }},
              {{ states('sensor.emhass_def_1_end_timestep')|int(0) }},
              {{ states('sensor.emhass_def_2_end_timestep')|int(0) }}
            ]